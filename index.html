<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SWAG 2025</title>
<style>
  body {
    font-family: sans-serif;
    background: #f5f5f5;
    padding: 20px;
  }
  h1 {
    text-align: center;
    margin-bottom: 20px;
  }

  .timetable {
    display: flex;
    justify-content: space-around;
    gap: 10px;
    flex-wrap: wrap;
  }
  .column {
    flex: 1;
    min-width: 250px;
    background: #fff;
    border: 2px solid #ccc;
    border-radius: 10px;
    padding: 10px;
    position: relative;
  }
  .column h2 {
    text-align: center;
    border-bottom: 1px solid #ddd;
    padding-bottom: 5px;
  }
  .time-grid {
    position: relative;
    height: 960px; /* 16 timmar (08–24) à 60px */
    border-left: 1px solid #ccc;
    margin-top: 10px;
    overflow: hidden;
  }
  .time-label {
    position: absolute;
    left: -45px;
    width: 40px;
    text-align: right;
    color: #666;
    font-size: 12px;
  }

  .box {
    position: absolute;
    background: #4c9aff;
    color: white;
    border-radius: 8px;
    cursor: grab;
    padding: 3px;
    min-height: 25px;
    overflow: hidden;
    user-select: none;
    width: 24%;
    box-sizing: border-box;
  }
  .box:active {
    cursor: grabbing;
  }

  .resize-handle {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 8px;
    cursor: ns-resize;
    background: rgba(255, 255, 255, 0.4);
    border-radius: 0 0 8px 8px;
  }

  .button-row {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 20px 0;
  }

  .addBtn {
    padding: 10px 15px;
    border: none;
    color: white;
    font-weight: bold;
    border-radius: 8px;
    cursor: pointer;
  }

  .externBtn { background: #2ecc71; }
  .workshopBtn { background: #e67e22; }
  .forelasningBtn { background: #9b59b6; }
  .aktivitetBtn { background: #4c9aff; }
  .middagBtn { background: pink; }

  #deletePanel {
    background: #fff;
    border: 2px solid #ccc;
    border-radius: 10px;
    padding: 15px;
    margin-top: 20px;
    width: 300px;
  }
  #deletePanel h3 {
    margin-top: 0;
    text-align: center;
  }
  #deleteList div {
    padding: 8px;
    background: #f2f2f2;
    border-radius: 6px;
    margin-bottom: 6px;
    cursor: pointer;
  }
  #deleteList div:hover {
    background: #e74c3c;
    color: white;
  }

  /* Sync panel */
  #syncPanel {
    background: #fff;
    border: 2px solid #ccc;
    border-radius: 10px;
    padding: 15px;
    margin-top: 20px;
    width: 300px;
  }

  #lastSaved {
    margin-top: 8px;
    font-size: 14px;
    color: #777;
  }

  .small {
    font-size: 13px;
    color: #666;
    margin-top: 6px;
  }

  input[type="password"] { box-sizing:border-box; }
  button.smallBtn { padding:6px 8px; border-radius:6px; border:0; cursor:pointer; }
</style>
</head>
<body>

<h1>Schemaläggning med 4 parallella aktiviteter</h1>

<div class="timetable">
  <div class="column"><h2>Torsdag</h2><div class="time-grid" id="grid-thursday"></div></div>
  <div class="column"><h2>Fredag</h2><div class="time-grid" id="grid-friday"></div></div>
  <div class="column"><h2>Lördag</h2><div class="time-grid" id="grid-saturday"></div></div>
  <div class="column"><h2>Söndag</h2><div class="time-grid" id="grid-sunday"></div></div>
</div>

<div class="button-row">
  <button class="addBtn externBtn">Extern</button>
  <button class="addBtn workshopBtn">Workshop</button>
  <button class="addBtn forelasningBtn">Föreläsning</button>
  <button class="addBtn aktivitetBtn">Aktivitet</button>
  <button class="addBtn middagBtn">Middag</button>
</div>

<div id="deletePanel">
  <h3>Radera aktivitet</h3>
  <div id="deleteList"></div>
</div>

<!-- GitHub Sync Panel -->
<div id="syncPanel">
  <h3>GitHub-synk</h3>

  <label for="githubToken">GitHub Token:</label>
  <input id="githubToken" type="password" placeholder="Klistra in token" style="width:100%;padding:6px;margin-bottom:8px;">

  <div style="display:flex;gap:8px;">
    <button id="saveTokenBtn" class="smallBtn" style="background:#4c9aff;color:white;flex:1">Spara token</button>
    <button id="clearTokenBtn" class="smallBtn" style="background:#e74c3c;color:white;flex:1">Radera token</button>
  </div>

  <button id="saveToGitHubBtn" style="width:100%;padding:10px;background:#4c9aff;color:white;border:none;border-radius:8px;cursor:pointer;margin-top:10px;">
    Spara till GitHub
  </button>

  <button id="loadFromGitHubBtn" style="margin-top:10px;width:100%;padding:10px;background:#2ecc71;color:white;border:none;border-radius:8px;cursor:pointer;">
    Ladda från GitHub
  </button>

  <div id="githubStatus" style="margin-top:10px;color:#555;font-size:14px;"></div>
  <div id="lastSaved">Senast sparad: –</div>
  <div class="small">Token sparas lokalt i din webbläsare (localStorage).</div>
</div>

<script>
/* ---------------------------
   Din ursprungliga kod (bevarad)
   --------------------------- */
const grids = document.querySelectorAll(".time-grid");
const startHour = 8;
const hourHeight = 60;
const trackWidth = 25;

/* Rita tidsskala */
grids.forEach(grid => {
  for (let h = startHour; h <= 24; h++) {
    const label = document.createElement("div");
    label.className = "time-label";
    label.textContent = `${String(h).padStart(2, '0')}:00`;
    label.style.top = `${(h - startHour) * hourHeight - 6}px`;
    grid.appendChild(label);

    const line = document.createElement("div");
    line.style.position = "absolute";
    line.style.top = `${(h - startHour) * hourHeight}px`;
    line.style.left = "0";
    line.style.right = "0";
    line.style.height = "1px";
    line.style.background = "#ddd";
    grid.appendChild(line);
  }
});

/* Ladda från localStorage */
document.addEventListener("DOMContentLoaded", () => {
  // fyll token-input från localStorage om sparad
  const storedToken = localStorage.getItem("GH_TOKEN");
  if (storedToken) document.getElementById("githubToken").value = storedToken;

  const saved = JSON.parse(localStorage.getItem("timetableDataV3") || "{}");
  Object.keys(saved).forEach(day => {
    const grid = document.getElementById(`grid-${day}`);
    if (!grid) return;
    saved[day].forEach(item => {
      const newBox = createBox(item.text, item.top, item.height, item.track, item.color);
      grid.appendChild(newBox);
    });
  });
  updateDeletePanel();
});

/* Skapa box */
function createBox(text, top = 0, height = 60, track = 0, color = null) {
  const box = document.createElement("div");
  box.classList.add("box");
  box.textContent = text;
  box.draggable = true;
  box.style.top = top + "px";
  box.style.left = (track * trackWidth) + "%";
  box.style.height = height + "px";
  if (color) box.style.background = color;

  const handle = document.createElement("div");
  handle.classList.add("resize-handle");
  box.appendChild(handle);

  addDragEvents(box);
  addResizeEvents(box, handle);
  addEditEvents(box);

  return box;
}

/* Radera panel */
function updateDeletePanel() {
  const deleteList = document.getElementById("deleteList");
  deleteList.innerHTML = "";

  const allBoxes = document.querySelectorAll(".box");

  allBoxes.forEach((box, index) => {
    const entry = document.createElement("div");
    entry.textContent = box.textContent.trim() || `Aktivitet ${index+1}`;
    entry.addEventListener("click", () => {
      if (confirm("Press OK to delete activity.")) {
        box.remove();
        saveTimetable();
        updateDeletePanel();
      }
    });
    deleteList.appendChild(entry);
  });
}

/* Lägga till nya boxar */
document.querySelector(".externBtn").onclick = () => addNewBox("Extern aktivitet", "#2ecc71");
document.querySelector(".workshopBtn").onclick = () => addNewBox("Workshop", "#e67e22");
document.querySelector(".forelasningBtn").onclick = () => addNewBox("Föreläsning", "#9b59b6");
document.querySelector(".aktivitetBtn").onclick = () => addNewBox("Aktivitet", "#4c9aff");
document.querySelector(".middagBtn").onclick = () => addNewBox("Middag", "pink");

function addNewBox(text, color) {
  const box = createBox(text, 0, 60, 0, color);
  document.getElementById("grid-thursday").appendChild(box);
  saveTimetable();
  updateDeletePanel();
}

/* Drag */
function addDragEvents(box) {
  let offsetY = 0, offsetX = 0;

  box.addEventListener("dragstart", (e) => {
    e.dataTransfer.effectAllowed = "move";
    offsetY = e.offsetY;
    offsetX = e.offsetX;
    setTimeout(() => box.classList.add("dragging"), 0);
  });

  box.addEventListener("dragend", () => {
    box.classList.remove("dragging");
    saveTimetable();
    updateDeletePanel();
  });
}

grids.forEach(grid => {
  grid.addEventListener("dragover", (e) => {
    e.preventDefault();
    const dragging = document.querySelector(".dragging");
    if (!dragging) return;

    const rect = grid.getBoundingClientRect();
    let y = e.clientY - rect.top - 48;
    y = Math.max(0, Math.min(y, grid.clientHeight - dragging.clientHeight));

    let x = e.clientX - rect.left;
    const track = Math.min(3, Math.max(0, Math.floor((x / rect.width) * 4)));

    dragging.style.top = `${y}px`;
    dragging.style.left = `${track * trackWidth}%`;

    if (dragging.parentElement !== grid) grid.appendChild(dragging);
  });

  grid.addEventListener("drop", () => saveTimetable());
});

/* Resize */
function addResizeEvents(box, handle) {
  let isResizing = false;
  let startY, startHeight;

  handle.addEventListener("mousedown", (e) => {
    e.preventDefault();
    e.stopPropagation();
    isResizing = true;
    startY = e.clientY;
    startHeight = parseInt(box.style.height);
    document.body.style.userSelect = "none";
  });

  document.addEventListener("mousemove", (e) => {
    if (!isResizing) return;
    const newHeight = Math.max(30, startHeight + (e.clientY - startY));
    box.style.height = newHeight + "px";
  });

  document.addEventListener("mouseup", () => {
    if (isResizing) {
      isResizing = false;
      document.body.style.userSelect = "";
      saveTimetable();
    }
  });
}

/* Edit */
function addEditEvents(box) {
  box.addEventListener("dblclick", () => {
    const oldText = box.textContent.replace(/\s+$/, "");
    const input = document.createElement("input");
    input.type = "text";
    input.value = oldText;
    input.style.width = "90%";
    box.textContent = "";
    box.appendChild(input);
    input.focus();

    input.addEventListener("blur", () => {
      box.textContent = input.value || oldText;
      const handle = document.createElement("div");
      handle.classList.add("resize-handle");
      box.appendChild(handle);
      addResizeEvents(box, handle);
      saveTimetable();
    });

    input.addEventListener("keydown", e => e.key === "Enter" && input.blur());
  });
}

/* Save to localStorage */
function saveTimetable() {
  const data = {};
  grids.forEach(grid => {
    const boxes = grid.querySelectorAll(".box");
    const id = grid.id.replace("grid-", "");
    data[id] = Array.from(boxes).map(b => ({
      text: b.textContent.trim(),
      top: parseInt(b.style.top) || 0,
      height: parseInt(b.style.height) || 60,
      track: Math.round(parseFloat(b.style.left) / trackWidth),
      color: b.style.background || ""
    }));
  });
  localStorage.setItem("timetableDataV3", JSON.stringify(data));
}

/* ---------------------------
   GITHUB SYNC (localStorage token)
   --------------------------- */
const GITHUB_USER = "PetteriVest";
const GITHUB_REPO = "Swag2025Schema";
const GITHUB_FILE = "data.json";
const COMMIT_MESSAGE = "Auto-sync from webapp";

let lastSha = null;

/* Hjälp: byt statustext */
function setStatus(text) {
  document.getElementById("githubStatus").textContent = text;
}

/* Läs token (från input eller localStorage) */
function getToken() {
  const input = document.getElementById("githubToken").value.trim();
  if (input) return input;
  return localStorage.getItem("GH_TOKEN") || "";
}

/* Spara token i localStorage via knapp */
document.getElementById("saveTokenBtn").addEventListener("click", () => {
  const val = document.getElementById("githubToken").value.trim();
  if (!val) return alert("Klistra in token i fältet först.");
  localStorage.setItem("GH_TOKEN", val);
  setStatus("Token sparad lokalt.");
});

/* Radera token */
document.getElementById("clearTokenBtn").addEventListener("click", () => {
  localStorage.removeItem("GH_TOKEN");
  document.getElementById("githubToken").value = "";
  setStatus("Token raderad.");
});

/* ---- Load från GitHub ---- */
async function loadFromGitHub() {
  const token = getToken();
  if (!token) return alert("Du måste ange token (eller spara i localStorage).");

  setStatus("Laddar från GitHub...");
  const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${GITHUB_FILE}`;

  try {
    const res = await fetch(url, {
      headers: { Authorization: `Bearer ${token}` }
    });

    if (res.status === 404) {
      setStatus("Filen hittades inte i repot.");
      return;
    }
    if (!res.ok) {
      const txt = await res.text();
      throw new Error("HTTP " + res.status + " " + txt);
    }

    const file = await res.json();
    lastSha = file.sha;

    // decode content
    const decoded = JSON.parse(atob(file.content.replace(/\n/g, '')));

    // rensa och rendera
    grids.forEach(g => g.innerHTML = "");
    localStorage.setItem("timetableDataV3", JSON.stringify(decoded));

    Object.keys(decoded).forEach(day => {
      const grid = document.getElementById(`grid-${day}`);
      if (!grid) return;
      decoded[day].forEach(item => {
        const box = createBox(item.text, item.top, item.height, item.track, item.color);
        grid.appendChild(box);
      });
    });

    updateDeletePanel();
    setStatus("Data laddad från GitHub.");
    document.getElementById("lastSaved").textContent = "Senast sparad: Hämtad från GitHub " + new Date().toLocaleString();

  } catch (err) {
    console.error(err);
    setStatus("Fel vid laddning: " + (err.message || err));
  }
}

/* ---- Save to GitHub ---- */
async function saveToGitHub() {
  const token = getToken();
  if (!token) return alert("Du måste ange token (eller spara i localStorage).");

  setStatus("Sparar till GitHub...");

  // ta data från localStorage (samma format som vi sparar lokalt)
  const dataObj = JSON.parse(localStorage.getItem("timetableDataV3") || "{}");
  const dataStr = JSON.stringify(dataObj, null, 2);
  const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${GITHUB_FILE}`;

  try {
    // hämta senaste sha om vi inte redan har
    if (!lastSha) {
      const headRes = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
      if (headRes.ok) {
        const headFile = await headRes.json();
        lastSha = headFile.sha;
      } else if (headRes.status !== 404) {
        const txt = await headRes.text();
        throw new Error("Fel vid läsning av filmetadata: " + headRes.status + " " + txt);
      }
    }

    const body = {
      message: COMMIT_MESSAGE,
      content: btoa(unescape(encodeURIComponent(dataStr)))
    };
    if (lastSha) body.sha = lastSha;

    const putRes = await fetch(url, {
      method: "PUT",
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });

    if (!putRes.ok) {
      const txt = await putRes.text();
      throw new Error("PUT misslyckades: " + putRes.status + " " + txt);
    }

    const result = await putRes.json();
    lastSha = result.content.sha;

    setStatus("Sparat till GitHub.");
    const now = new Date();
    document.getElementById("lastSaved").textContent = "Senast sparad: " + now.toLocaleString();

  } catch (err) {
    console.error(err);
    setStatus("Fel vid sparning: " + (err.message || err));
  }
}

/* Koppla knappar */
document.getElementById("saveToGitHubBtn").addEventListener("click", () => {
  // se till att lokal data är uppdaterad innan push
  saveTimetable();
  saveToGitHub();
});
document.getElementById("loadFromGitHubBtn").addEventListener("click", loadFromGitHub);

</script>

</body>
</html>

